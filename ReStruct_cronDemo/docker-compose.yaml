version: '3'
services:
  #1.EtcdæœåŠ¡
  etcd:
    image: quay.io/coreos/etcd:v3.5.21
    container_name: etcd-server
    environment:
      - ETCD_LOG_LEVEL=debug
    # ğŸ”¥ å…³é”®ç‚¹ï¼šå®˜æ–¹é•œåƒå¿…é¡»åŠ è¿™è¡Œå‘½ä»¤ï¼Œå…è®¸å¤–éƒ¨è¿æ¥
    command: 
      - /usr/local/bin/etcd
      - --advertise-client-urls=http://etcd:2379
      - --listen-client-urls=http://0.0.0.0:2379
    ports:
      - "2379:2379"
  #2.MasteræœåŠ¡
  master:
    build: . #ä½¿ç”¨å½“å‰ç›®å½•çš„Dockerfileæ„å»º
    container_name: cron-master
    command: ./master-bin #è¦†ç›–Dockerfileé‡Œçš„CMDï¼Œè¿è¡Œmaster
    ports:
      - "50012:50012" #æŠŠå®¹å™¨çš„50012æ˜ å°„åˆ°ç”µè„‘çš„50012
    environment:
      - ETCD_ENDPOINTS=etcd:2379 #å…³é”®ï¼å‘Šè¯‰å®ƒetcdåœ¨å“ªï¼ˆç”¨æœåŠ¡åetcdï¼‰
    depends_on:
      - etcd #ç­‰etcdå¯åŠ¨äº†å†å¯åŠ¨
      

  #3.workeræœåŠ¡ï¼ˆæˆ‘ä»¬è¿™é‡Œå¯åŠ¨3ä¸ªèŠ‚ç‚¹ï¼‰
  worker:
    build: .
    command: ./worker-bin #è¿è¡Œworker
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MONGO_URI=mongodb://mongo:27017
      - KAFKA_BROKERS=kafka:9092 #æ³¨å…¥kafkaåœ°å€
    depends_on:
      - etcd
      - mongo
      
      - kafka
    deploy:
      replicas: 3 #å¯åŠ¨3ä¸ªWorkeræ¨¡æ‹Ÿåˆ†å¸ƒå¼
    #è¿™é‡Œçš„ deploy replicas æ˜¯ Docker Swarm çš„å†™æ³•ï¼Œ
    # åœ¨æ™®é€š compose é‡Œï¼Œæˆ‘ä»¬éœ€è¦ç”¨å‘½ä»¤å‚æ•° --scale
    # æˆ–è€…æˆ‘ä»¬ç®€å•ç‚¹ï¼Œç›´æ¥å¤åˆ¶ç²˜è´´å®šä¹‰ worker1, worker2, worker3 ä¹Ÿå¯ä»¥
    # ä½†æœ€æ ‡å‡†çš„åšæ³•æ˜¯ç”¨ scale å‘½ä»¤ (ä¸‹é¢ä¼šæ•™ä½ )

  #4.å¯åŠ¨MongoDBæœåŠ¡
  mongo:
    image: mongo:latest
    container_name: cron-mongo
    environment:
      - MONGO_URI=mongodb://mongo:27017
    ports:
      - "27017:27017"

  #5. å¯åŠ¨MySQLæœåŠ¡
  mysql:
    image: mysql:5.7
    container_name: cron-mysql
    platform: linux/amd64 #é˜²æ­¢è‹¹æœM1/M2å…¼å®¹æ€§é—®é¢˜
    environment:
      MYSQL_ROOT_PASSWORD: "123456"
      MYSQL_DATABASE: "cron-demo"
    ports:
      - "3307:3306"
  #6. å¯åŠ¨MockæœåŠ¡
  mock-services:
    build: .
    container_name: cron-mock
    command: ./mock-bin #è¿è¡Œmockç¨‹åº
    ports:
      - "8877:8877"
    depends_on:
      - mysql
  #7. KafkaæœåŠ¡ï¼ˆKRaftæ¨¡å¼ï¼Œè½»é‡é¿å…Zookeeperï¼‰
  kafka:
    image: apache/kafka:4.2.0
    container_name: cron-kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_NODE_ID=1 #ç»™è‡ªå·±ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼ŒKafkaé›†ç¾¤é‡Œæ¯ä¸ªèŠ‚ç‚¹è¦æœ‰ä¸€ä¸ªID
      - KAFKA_PROCESS_ROLES=broker,controller #è¿™ä¸ªèŠ‚ç‚¹æ—¢æ˜¯controlleråˆæ˜¯brokerï¼Œcontrollerè´Ÿè´£ç®¡ç†å…ƒæ•°æ®ï¼Œbrokerè´Ÿè´£æ”¶å‘æ¶ˆæ¯
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093 # å…ƒæ•°æ®é€‰ä¸¾é›†ç¾¤åªæœ‰ 1 ä¸ª controller èŠ‚ç‚¹ï¼Œå°±åœ¨ kafka:9093ã€‚
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093 #å¯åŠ¨ä¸¤ä¸ªç›‘å¬ç«¯å£ï¼Œ9092ç»™å¤–éƒ¨å®¢æˆ·ç«¯ï¼ˆbrokerï¼‰ï¼Œ9093ç»™controller
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092 # å‘Šè¯‰Workerè¿è¿™ä¸ªåœ°å€
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT #æ¯ä¸ªlistenerç”¨ä»€ä¹ˆåè®®
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER #controllerå¿…é¡»ç”¨åä¸ºCONTROLLERçš„ç›‘å¬å™¨ï¼Œå°±æ˜¯9093ç«¯å£
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT #brokeré€šè¿‡PLAINTEXTï¼ˆ9092ï¼‰äº’ç›¸é€šä¿¡
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: cron-kafka-ui
    ports:
      - "8083:8083" #æµè§ˆå™¨è®¿é—®8083å³å¯çœ‹æ¶ˆæ¯
    environment:
      - SERVER_PORT=8083
      - KAFKA_CLUSTERS_0_NAME=local-kraft
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
    depends_on:
      - kafka
  log-consumer:
    build: .
    container_name: cron-consumer
    command: ./consumer-bin
    environment:
      - KAFKA_BROKERS=kafka:9092
      - MONGO_URI=mongodb://mongo:27017
    depends_on:
      - kafka
      - mongo
  # ğŸš€ [æ–°å¢æœåŠ¡] è´Ÿè´£ç›‘å¬æ­»ä¿¡é˜Ÿåˆ—å¹¶æŠ¥è­¦
  alert-service:
    build: .
    container_name: cron-alert
    command: ./alert-bin
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on:
      - kafka
